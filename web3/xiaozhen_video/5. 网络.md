BTC协议运行在应用层，下面的网络层是基于P2P overlay network。网络结构很简单，所有节点都是对等的，没有超级节点或主节点。
想要加入这个网络，需要知道一个种子节点seed node，他会告诉你其他节点的信息。节点之间通过TCP通信，有利于穿透防火墙。

退出网络时不需要其他操作，退出应用程序进程即可。别的节点一段时间后没有收到你的消息，就会删掉你。

![b26c2536300015c84fc699576bdc6d69.png](./images/98b3b961-bc30-42ae-9e78-5f9acaab41de%20.png)

# 设计原则
简单，鲁棒。而不是高效。
Simple, robust, but not efficient.

消息传播采用flooding的方式。节点第一次收到某个消息时，转发给所有零距节点，同时记录已收到此消息。下次再收到此消息时，就不再转发给零距节点。零距节点的选取是随机的，没有考虑底层拓扑结构。相隔很远的节点也可能被选择为零距节点。

BTC底层系统中，需要维护一个等待上链的交易集合。第一次收到一个交易时，将其加入集合，并转发给零距节点。之后再收到时就不再转发。
转发的前提是交易是合法的，所以需要提前验证。

Risk：有可能收到两个冲突的交易：
A->B
A->C
根据节点在网络中位置不同，有可能收到的顺序也不同。
集合中的交易被写入到区块链中，就需要从集合中删除该交易。如果此节点在集合中写入的是A到B的交易，但收到区块链中的是A到C的交易。此时仍然需要删除A到B的交易，因为这是双花的非法交易。

新发布的区块和新发布的交易，在网络上的传播方式是类似的。除了检查区块内容合法性之外，还要检查是不是在最长合法链上。越大的区块，在网络上传播速度就越慢。**BTC协议对于区块大小的限制是1M**。
之所以限制是这个，因为BTC的网络传输很耗带宽，1M大小的区块需要几十秒才能传播给网络中绝大多数节点。

BTC网络传播方式属于Best Effort。一个交易发布出去，不一定所有节点都能收到，且顺序不一定一致。也不一定所有节点都按照要求，正确的转发所有合法交易。

这些都是去中心化网络中面临的实际问题。